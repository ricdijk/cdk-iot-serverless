"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const src_1 = require("../src");
const assert_1 = require("assert");
var fs = require("fs");
const sinon_1 = require("sinon");
const sb = sinon_1.sandbox.create();
describe("testCSVConverter3", function () {
    afterEach(function () {
        sb.restore();
    });
    it("should parse large csv file with UTF-8 without spliting characters", function (done) {
        var testData = __dirname + "/data/large-utf8.csv";
        var rs = fs.createReadStream(testData);
        var csvConverter = src_1.default({});
        var count = 0;
        csvConverter.preRawData(function (csvRawData) {
            assert_1.default(csvRawData.charCodeAt(0) < 2000);
            return csvRawData;
        });
        csvConverter.on("data", function () {
            count++;
        });
        csvConverter.then(function () {
            assert_1.default(count === 5290);
            done();
        });
        rs.pipe(csvConverter);
    });
    it("should setup customise type convert function", function (done) {
        src_1.default({
            checkType: true,
            colParser: {
                "column1": "string",
                "column5": function (item, head, resultRow, row, i) {
                    assert_1.default.equal(item, '{"hello":"world"}');
                    assert_1.default.equal(head, "column5"),
                        assert_1.default(resultRow);
                    assert_1.default(row);
                    assert_1.default.equal(i, 5);
                    return "hello world";
                }
            }
        })
            .fromFile(__dirname + "/data/dataWithType")
            .subscribe(function (json) {
            assert_1.default.equal(typeof json.column1, "string");
            assert_1.default.equal(json.column5, "hello world");
            assert_1.default.strictEqual(json["name#!"], false);
            assert_1.default.strictEqual(json["column9"], true);
        })
            .on('done', function () {
            done();
        });
    });
    it("should accept pipe as quote", function (done) {
        src_1.default({
            quote: "|",
            output: "csv"
        })
            .fromFile(__dirname + "/data/pipeAsQuote")
            .subscribe(function (csv) {
            assert_1.default.equal(csv[2], "blahhh, blah");
        })
            .on('done', function () {
            done();
        });
    });
    it("emit file not exists error when try to open a non-exists file", function () {
        let called = false;
        const cb = sb.spy((err) => {
            assert_1.default(err.toString().indexOf("File does not exist") > -1);
        });
        return src_1.default()
            .fromFile("somefile")
            .subscribe(function (csv) {
        })
            .on("error", cb)
            .then(() => {
            assert_1.default(false);
        }, (err) => {
            assert_1.default.equal(cb.callCount, 1);
        });
    });
    it("should include column that is both included and excluded", () => {
        return src_1.default({
            includeColumns: /b/,
            ignoreColumns: /a|b/
        })
            .fromString(`a,b,c
1,2,3
4,5,6`)
            .subscribe((d) => {
            assert_1.default(d.b);
            assert_1.default(!d.a);
        });
    });
    it("should allow async preLine hook", () => {
        return src_1.default()
            .preFileLine((line) => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    resolve(line + "changed");
                }, 20);
            });
        })
            .fromString(`a,b
1,2`)
            .subscribe((d) => {
            assert_1.default(d.bchanged);
            assert_1.default.equal(d.bchanged, "2changed");
        });
    });
    it("should allow async subscribe function", () => {
        return src_1.default({ trim: true })
            .fromString(`a,b,c
    1,2,3
    4,5,6`)
            .subscribe((d) => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    d.a = 10;
                    resolve();
                }, 20);
            });
        })
            .then((d) => {
            assert_1.default.equal(d[0].a, 10);
            assert_1.default.equal(d[1].a, 10);
        });
    });
    it("should propagate value to next then", () => {
        return src_1.default({ trim: true })
            .fromString(`a,b,c
  1,2,3
  4,5,6`)
            .then(undefined, undefined)
            .then((d) => {
            assert_1.default.equal(d.length, 2);
            assert_1.default.equal(d[0].a, "1");
        });
    });
    it("should propagate error to next then", () => {
        return src_1.default({ trim: true })
            .fromFile(__dirname + "/data/dataWithUnclosedQuotes")
            .then(undefined, undefined)
            .then(() => {
            assert_1.default(false);
        }, (err) => {
            assert_1.default(err);
            assert_1.default.equal(err.err, "unclosed_quote");
        });
    });
    it("should fallback to text is number can not be parsed", () => {
        return src_1.default({
            colParser: {
                "a": "number"
            }
        })
            .fromString(`a,b,c
  1,2,3
  fefe,5,6`)
            .then((d) => {
            assert_1.default.strictEqual(d[0].a, 1);
            assert_1.default.equal(d[1].a, "fefe");
        });
    });
    it("should omit a column", () => {
        return src_1.default({
            colParser: {
                "a": "omit"
            }
        })
            .fromString(`a,b,c
  1,2,3
  fefe,5,6`)
            .then((d) => {
            assert_1.default.strictEqual(d[0].a, undefined);
            assert_1.default.equal(d[1].a, undefined);
        });
    });
    it("could turn off quote and should trim even quote is turned off", () => {
        return src_1.default({
            quote: "off",
            trim: true
        })
            .fromString(`a,b,c
  "1","2","3"
  "fefe,5",6`)
            .then((d) => {
            assert_1.default.equal(d[0].a, '"1"');
            assert_1.default.equal(d[0].b, '"2"');
            assert_1.default.equal(d[1].a, '"fefe');
            assert_1.default.equal(d[1].b, '5"');
        });
    });
    it("should allow ignoreEmpty with checkColumn", () => {
        return src_1.default({
            checkColumn: true,
            ignoreEmpty: true
        })
            .fromString(`date,altitude,airtime
    2016-07-08,2000,23
    
    2016-07-09,3000,43`)
            .then((data) => {
        }, (err) => {
            console.log(err);
            assert_1.default(!err);
        });
    });
    it("should allow quotes without content", () => {
        const data = "a|^^|^b^";
        return src_1.default({
            delimiter: '|',
            quote: '^',
            noheader: true,
        })
            .fromString(data)
            .then((jsonObj) => {
            assert_1.default.equal(jsonObj[0].field2, "");
        });
    });
    it("should parse header with quotes correctly", function () {
        var testData = __dirname + "/data/csvWithUnclosedHeader";
        return src_1.default({
            headers: ["exam_date", "sample_no", "status", "sample_type", "patient_id", "last_name", "first_name", "gender_of_patient", "patient_birth_date", "patient_note", "patient_department", "accession_number", "sample_site", "physician", "operator", "department", "note", "test_order_code", "draw_time", "approval_status", "approval_time", "report_layout", "patient_account_number", "none_1", "errors_detected_during_measurement", "age", "error_code_01", "weight", "error_code_02", "height", "error_code_03", "hcg_beta_p", "error_code_04", "troponin_i_p", "error_code_05", "ck_mb_p", "error_code_06", "d_dimer_p", "error_code_07", "hscrp_p", "error_code_08", "myoglobin_p", "error_code_09", "nt_probnp", "error_code_10", "crp", "error_code_11", "bnp", "error_code_12", "tnt", "error_code_13", "demo_p", "error_code_14", "pct", "error_code_15"]
        })
            .fromFile(testData)
            .then((d) => {
            assert_1.default.equal(d.length, 2);
            assert_1.default.equal(d[0].sample_no, "12669");
        });
    });
    it("should stream json string correctly", function (done) {
        const data = `a,b,c
1,2,3
4,5,6`;
        let hasLeftBracket = false;
        let hasRightBracket = false;
        src_1.default({
            downstreamFormat: "array"
        })
            .fromString(data)
            .on("data", (d) => {
            const str = d.toString();
            if (str[0] === "[" && str.length === 2) {
                hasLeftBracket = true;
            }
            else if (str[0] === "]" && str.length === 2) {
                hasRightBracket = true;
            }
            else {
                assert_1.default.equal(str[str.length - 2], ",");
            }
        })
            .on("end", () => {
            assert_1.default.equal(hasLeftBracket, true);
            assert_1.default.equal(hasRightBracket, true);
            done();
        });
    });
    it("should stream json line correctly", function (done) {
        const data = `a,b,c
1,2,3
4,5,6`;
        src_1.default({
            downstreamFormat: "line"
        })
            .fromString(data)
            .on("data", (d) => {
            const str = d.toString();
            assert_1.default.notEqual(str[str.length - 2], ",");
        })
            .on("end", () => {
            done();
        });
    });
    it("should not send json if needEmitAll is false", async function () {
        const data = `a,b,c
1,2,3
4,5,6`;
        return src_1.default({
            needEmitAll: false
        })
            .fromString(data)
            .then((d) => {
            assert_1.default(d.length === 0);
        });
    });
    it("should convert null to null object", async function () {
        const data = `a,b,c
null,2,3
4,5,6`;
        return src_1.default({
            nullObject: true
        })
            .fromString(data)
            .then((d) => {
            assert_1.default.equal(d[0].a, null);
        });
    });
    it("should process period properly", async function () {
        const data = `a..,b,c
1,2,3
4,5,6`;
        return src_1.default({})
            .fromString(data)
            .then((d) => {
            assert_1.default.equal(d[0]["a.."], 1);
            assert_1.default.equal(d[1]["a.."], 4);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdENTVkNvbnZlcnRlcjMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0Q1NWQ29udmVydGVyMy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGdDQUF5QjtBQUN6QixtQ0FBNEI7QUFDNUIsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZCLGlDQUFnQztBQUVoQyxNQUFNLEVBQUUsR0FBRyxlQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDNUIsUUFBUSxDQUFDLG1CQUFtQixFQUFFO0lBQzVCLFNBQVMsQ0FBQztRQUNSLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNmLENBQUMsQ0FBQyxDQUFDO0lBQ0gsRUFBRSxDQUFDLG9FQUFvRSxFQUFFLFVBQVUsSUFBSTtRQUNyRixJQUFJLFFBQVEsR0FBRyxTQUFTLEdBQUcsc0JBQXNCLENBQUM7UUFDbEQsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLElBQUksWUFBWSxHQUFHLGFBQUcsQ0FBQyxFQUN0QixDQUFDLENBQUM7UUFDSCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxZQUFZLENBQUMsVUFBVSxDQUFDLFVBQVUsVUFBVTtZQUMxQyxnQkFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDeEMsT0FBTyxVQUFVLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUE7UUFDRixZQUFZLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRTtZQUN0QixLQUFLLEVBQUUsQ0FBQztRQUNWLENBQUMsQ0FBQyxDQUFDO1FBQ0gsWUFBWSxDQUFDLElBQUksQ0FBQztZQUNoQixnQkFBTSxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUMsQ0FBQztZQUN2QixJQUFJLEVBQUUsQ0FBQztRQUNULENBQUMsQ0FBQyxDQUFDO1FBQ0gsRUFBRSxDQUFD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c3JjXCI7XG5pbXBvcnQgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcbnZhciBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcbmltcG9ydCB7IHNhbmRib3ggfSBmcm9tIFwic2lub25cIjtcbmltcG9ydCBDU1ZFcnJvciBmcm9tIFwiLi4vc3JjL0NTVkVycm9yXCI7XG5jb25zdCBzYiA9IHNhbmRib3guY3JlYXRlKCk7XG5kZXNjcmliZShcInRlc3RDU1ZDb252ZXJ0ZXIzXCIsIGZ1bmN0aW9uICgpIHtcbiAgYWZ0ZXJFYWNoKGZ1bmN0aW9uICgpIHtcbiAgICBzYi5yZXN0b3JlKCk7XG4gIH0pO1xuICBpdChcInNob3VsZCBwYXJzZSBsYXJnZSBjc3YgZmlsZSB3aXRoIFVURi04IHdpdGhvdXQgc3BsaXRpbmcgY2hhcmFjdGVyc1wiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgIHZhciB0ZXN0RGF0YSA9IF9fZGlybmFtZSArIFwiL2RhdGEvbGFyZ2UtdXRmOC5jc3ZcIjtcbiAgICB2YXIgcnMgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKHRlc3REYXRhKTtcbiAgICB2YXIgY3N2Q29udmVydGVyID0gY3N2KHtcbiAgICB9KTtcbiAgICB2YXIgY291bnQgPSAwO1xuICAgIGNzdkNvbnZlcnRlci5wcmVSYXdEYXRhKGZ1bmN0aW9uIChjc3ZSYXdEYXRhKSB7XG4gICAgICBhc3NlcnQoY3N2UmF3RGF0YS5jaGFyQ29kZUF0KDApIDwgMjAwMCk7XG4gICAgICByZXR1cm4gY3N2UmF3RGF0YTtcbiAgICB9KVxuICAgIGNzdkNvbnZlcnRlci5vbihcImRhdGFcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgY291bnQrKztcbiAgICB9KTtcbiAgICBjc3ZDb252ZXJ0ZXIudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICBhc3NlcnQoY291bnQgPT09IDUyOTApO1xuICAgICAgZG9uZSgpO1xuICAgIH0pO1xuICAgIHJzLnBpcGUoY3N2Q29udmVydGVyKTtcbiAgfSk7XG4gIGl0KFwic2hvdWxkIHNldHVwIGN1c3RvbWlzZSB0eXBlIGNvbnZlcnQgZnVuY3Rpb25cIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICBjc3Yoe1xuICAgICAgY2hlY2tUeXBlOiB0cnVlLFxuICAgICAgY29sUGFyc2VyOiB7XG4gICAgICAgIFwiY29sdW1uMVwiOiBcInN0cmluZ1wiLFxuICAgICAgICBcImNvbHVtbjVcIjogZnVuY3Rpb24gKGl0ZW0sIGhlYWQsIHJlc3VsdFJvdywgcm93LCBpKSB7XG4gICAgICAgICAgYXNzZXJ0LmVxdWFsKGl0ZW0sICd7XCJoZWxsb1wiOlwid29ybGRcIn0nKTtcbiAgICAgICAgICBhc3NlcnQuZXF1YWwoaGVhZCwgXCJjb2x1bW41XCIpLFxuICAgICAgICAgICAgYXNzZXJ0KHJlc3VsdFJvdyk7XG4gICAgICAgICAgYXNzZXJ0KHJvdyk7XG4gICAgICAgICAgYXNzZXJ0LmVxdWFsKGksIDUpO1xuICAgICAgICAgIHJldHVybiBcImhlbGxvIHdvcmxkXCI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICAgICAgLmZyb21GaWxlKF9fZGlybmFtZSArIFwiL2RhdGEvZGF0YVdpdGhUeXBlXCIpXG4gICAgICAuc3Vic2NyaWJlKGZ1bmN0aW9uIChqc29uKSB7XG4gICAgICAgIGFzc2VydC5lcXVhbCh0eXBlb2YganNvbi5jb2x1bW4xLCBcInN0cmluZ1wiKTtcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGpzb24uY29sdW1uNSwgXCJoZWxsbyB3b3JsZFwiKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGpzb25bXCJuYW1lIyFcIl0sIGZhbHNlKTtcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGpzb25bXCJjb2x1bW45XCJdLCB0cnVlKTtcbiAgICAgIH0pXG4gICAgICAub24oJ2RvbmUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGRvbmUoKVxuICAgICAgfSk7XG4gIH0pXG4gIGl0KFwic2hvdWxkIGFjY2VwdCBwaXBlIGFzIHF1b3RlXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgY3N2KHtcbiAgICAgIHF1b3RlOiBcInxcIixcbiAgICAgIG91dHB1dDogXCJjc3ZcIlxuICAgIH0pXG4gICAgICAuZnJvbUZpbGUoX19kaXJuYW1lICsgXCIvZGF0YS9waXBlQXNRdW90ZVwiKVxuICAgICAgLnN1YnNjcmliZShmdW5jdGlvbiAoY3N2KSB7XG4gICAgICAgIGFzc2VydC5lcXVhbChjc3ZbMl0sIFwiYmxhaGhoLCBibGFoXCIpO1xuICAgICAgfSlcbiAgICAgIC5vbignZG9uZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZG9uZSgpXG4gICAgICB9KTtcbiAgfSlcbiAgaXQoXCJlbWl0IGZpbGUgbm90IGV4aXN0cyBlcnJvciB3aGVuIHRyeSB0byBvcGVuIGEgbm9uLWV4aXN0cyBmaWxlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgY2FsbGVkID0gZmFsc2U7XG4gICAgY29uc3QgY2IgPSBzYi5zcHkoKGVycikgPT4ge1xuICAgICAgYXNzZXJ0KGVyci50b1N0cmluZygpLmluZGV4T2YoXCJGaWxlIGRvZXMgbm90IGV4aXN0XCIpID4gLTEpO1xuICAgIH0pO1xuICAgIHJldHVybiBjc3YoKVxuICAgICAgLmZyb21GaWxlKFwic29tZWZpbGVcIilcbiAgICAgIC5zdWJzY3JpYmUoZnVuY3Rpb24gKGNzdikge1xuXG4gICAgICB9KVxuICAgICAgLm9uKFwiZXJyb3JcIiwgY2IpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGFzc2VydChmYWxzZSk7XG4gICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgIGFzc2VydC5lcXVhbChjYi5jYWxsQ291bnQsIDEpO1xuICAgICAgfSlcblxuICB9KVxuICBpdChcInNob3VsZCBpbmNsdWRlIGNvbHVtbiB0aGF0IGlzIGJvdGggaW5jbHVkZWQgYW5kIGV4Y2x1ZGVkXCIsICgpID0+IHtcbiAgICByZXR1cm4gY3N2KHtcbiAgICAgIGluY2x1ZGVDb2x1bW5zOiAvYi8sXG4gICAgICBpZ25vcmVDb2x1bW5zOiAvYXxiL1xuICAgIH0pXG4gICAgICAuZnJvbVN0cmluZyhgYSxiLGNcbjEsMiwzXG40LDUsNmApXG4gICAgICAuc3Vic2NyaWJlKChkKSA9PiB7XG4gICAgICAgIGFzc2VydChkLmIpO1xuICAgICAgICBhc3NlcnQoIWQuYSk7XG4gICAgICB9KVxuICB9KVxuICBpdChcInNob3VsZCBhbGxvdyBhc3luYyBwcmVMaW5lIGhvb2tcIiwgKCkgPT4ge1xuICAgIHJldHVybiBjc3YoKVxuICAgICAgLnByZUZpbGVMaW5lKChsaW5lKSA9PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICByZXNvbHZlKGxpbmUgKyBcImNoYW5nZWRcIilcbiAgICAgICAgICB9LCAyMCk7XG5cbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICAuZnJvbVN0cmluZyhgYSxiXG4xLDJgKVxuICAgICAgLnN1YnNjcmliZSgoZCkgPT4ge1xuICAgICAgICBhc3NlcnQoZC5iY2hhbmdlZCk7XG4gICAgICAgIGFzc2VydC5lcXVhbChkLmJjaGFuZ2VkLCBcIjJjaGFuZ2VkXCIpO1xuICAgICAgfSlcblxuICB9KVxuXG4gIGl0KFwic2hvdWxkIGFsbG93IGFzeW5jIHN1YnNjcmliZSBmdW5jdGlvblwiLCAoKSA9PiB7XG4gICAgcmV0dXJuIGNzdih7IHRyaW06IHRydWUgfSlcbiAgICAgIC5mcm9tU3RyaW5nKGBhLGIsY1xuICAgIDEsMiwzXG4gICAgNCw1LDZgKVxuICAgICAgLnN1YnNjcmliZSgoZCkgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgZC5hID0gMTA7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSwgMjApO1xuICAgICAgICB9KVxuICAgICAgfSlcbiAgICAgIC50aGVuKChkKSA9PiB7XG4gICAgICAgIGFzc2VydC5lcXVhbChkWzBdLmEsIDEwKTtcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGRbMV0uYSwgMTApO1xuICAgICAgfSlcbiAgfSlcbiAgaXQoXCJzaG91bGQgcHJvcGFnYXRlIHZhbHVlIHRvIG5leHQgdGhlblwiLCAoKSA9PiB7XG4gICAgcmV0dXJuIGNzdih7IHRyaW06IHRydWUgfSlcbiAgICAgIC5mcm9tU3RyaW5nKGBhLGIsY1xuICAxLDIsM1xuICA0LDUsNmApXG4gICAgICAudGhlbih1bmRlZmluZWQsIHVuZGVmaW5lZClcbiAgICAgIC50aGVuKChkKSA9PiB7XG4gICAgICAgIGFzc2VydC5lcXVhbChkLmxlbmd0aCwgMik7XG4gICAgICAgIGFzc2VydC5lcXVhbChkWzBdLmEsIFwiMVwiKTtcbiAgICAgIH0pXG5cbiAgfSlcbiAgaXQoXCJzaG91bGQgcHJvcGFnYXRlIGVycm9yIHRvIG5leHQgdGhlblwiLCAoKSA9PiB7XG4gICAgcmV0dXJuIGNzdih7IHRyaW06IHRydWUgfSlcbiAgICAgIC5mcm9tRmlsZShfX2Rpcm5hbWUgKyBcIi9kYXRhL2RhdGFXaXRoVW5jbG9zZWRRdW90ZXNcIilcbiAgICAgIC50aGVuKHVuZGVmaW5lZCwgdW5kZWZpbmVkKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBhc3NlcnQoZmFsc2UpXG4gICAgICB9LCAoZXJyOiBDU1ZFcnJvcikgPT4ge1xuICAgICAgICBhc3NlcnQoZXJyKTtcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGVyci5lcnIsIFwidW5jbG9zZWRfcXVvdGVcIik7XG4gICAgICB9KVxuICB9KVxuICBpdChcInNob3VsZCBmYWxsYmFjayB0byB0ZXh0IGlzIG51bWJlciBjYW4gbm90IGJlIHBhcnNlZFwiLCAoKSA9PiB7XG4gICAgcmV0dXJuIGNzdih7XG4gICAgICBjb2xQYXJzZXI6IHtcbiAgICAgICAgXCJhXCI6IFwibnVtYmVyXCJcbiAgICAgIH1cbiAgICB9KVxuICAgICAgLmZyb21TdHJpbmcoYGEsYixjXG4gIDEsMiwzXG4gIGZlZmUsNSw2YClcbiAgICAgIC50aGVuKChkKSA9PiB7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChkWzBdLmEsIDEpO1xuICAgICAgICBhc3NlcnQuZXF1YWwoZFsxXS5hLCBcImZlZmVcIik7XG4gICAgICB9KVxuICB9KVxuICBpdChcInNob3VsZCBvbWl0IGEgY29sdW1uXCIsICgpID0+IHtcbiAgICByZXR1cm4gY3N2KHtcbiAgICAgIGNvbFBhcnNlcjoge1xuICAgICAgICBcImFcIjogXCJvbWl0XCJcbiAgICAgIH1cbiAgICB9KVxuICAgICAgLmZyb21TdHJpbmcoYGEsYixjXG4gIDEsMiwzXG4gIGZlZmUsNSw2YClcbiAgICAgIC50aGVuKChkKSA9PiB7XG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChkWzBdLmEsIHVuZGVmaW5lZCk7XG4gICAgICAgIGFzc2VydC5lcXVhbChkWzFdLmEsIHVuZGVmaW5lZCk7XG4gICAgICB9KVxuICB9KVxuICBpdChcImNvdWxkIHR1cm4gb2ZmIHF1b3RlIGFuZCBzaG91bGQgdHJpbSBldmVuIHF1b3RlIGlzIHR1cm5lZCBvZmZcIiwgKCkgPT4ge1xuICAgIHJldHVybiBjc3Yoe1xuICAgICAgcXVvdGU6IFwib2ZmXCIsXG4gICAgICB0cmltOiB0cnVlXG4gICAgfSlcbiAgICAgIC5mcm9tU3RyaW5nKGBhLGIsY1xuICBcIjFcIixcIjJcIixcIjNcIlxuICBcImZlZmUsNVwiLDZgKVxuICAgICAgLnRoZW4oKGQpID0+IHtcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGRbMF0uYSwgJ1wiMVwiJyk7XG4gICAgICAgIGFzc2VydC5lcXVhbChkWzBdLmIsICdcIjJcIicpO1xuICAgICAgICBhc3NlcnQuZXF1YWwoZFsxXS5hLCAnXCJmZWZlJyk7XG4gICAgICAgIGFzc2VydC5lcXVhbChkWzFdLmIsICc1XCInKTtcbiAgICAgIH0pXG4gIH0pXG4gIGl0KFwic2hvdWxkIGFsbG93IGlnbm9yZUVtcHR5IHdpdGggY2hlY2tDb2x1bW5cIiwgKCkgPT4ge1xuICAgIHJldHVybiBjc3Yoe1xuICAgICAgY2hlY2tDb2x1bW46IHRydWUsXG4gICAgICBpZ25vcmVFbXB0eTogdHJ1ZVxuICAgIH0pXG4gICAgICAuZnJvbVN0cmluZyhgZGF0ZSxhbHRpdHVkZSxhaXJ0aW1lXG4gICAgMjAxNi0wNy0wOCwyMDAwLDIzXG4gICAgXG4gICAgMjAxNi0wNy0wOSwzMDAwLDQzYClcbiAgICAgIC50aGVuKChkYXRhKSA9PiB7XG5cbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgYXNzZXJ0KCFlcnIpO1xuICAgICAgfSlcbiAgfSk7XG4gIGl0KFwic2hvdWxkIGFsbG93IHF1b3RlcyB3aXRob3V0IGNvbnRlbnRcIiwgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGEgPSBcImF8Xl58XmJeXCI7XG4gICAgcmV0dXJuIGNzdih7XG4gICAgICBkZWxpbWl0ZXI6ICd8JyxcbiAgICAgIHF1b3RlOiAnXicsXG4gICAgICBub2hlYWRlcjogdHJ1ZSxcbiAgICB9KVxuICAgICAgLmZyb21TdHJpbmcoZGF0YSlcbiAgICAgIC50aGVuKChqc29uT2JqKSA9PiB7XG4gICAgICAgIGFzc2VydC5lcXVhbChqc29uT2JqWzBdLmZpZWxkMiwgXCJcIik7XG4gICAgICB9KTtcbiAgfSlcbiAgaXQoXCJzaG91bGQgcGFyc2UgaGVhZGVyIHdpdGggcXVvdGVzIGNvcnJlY3RseVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHRlc3REYXRhID0gX19kaXJuYW1lICsgXCIvZGF0YS9jc3ZXaXRoVW5jbG9zZWRIZWFkZXJcIjtcbiAgICByZXR1cm4gY3N2KHtcbiAgICAgIGhlYWRlcnM6IFtcImV4YW1fZGF0ZVwiLCBcInNhbXBsZV9ub1wiLCBcInN0YXR1c1wiLCBcInNhbXBsZV90eXBlXCIsIFwicGF0aWVudF9pZFwiLCBcImxhc3RfbmFtZVwiLCBcImZpcnN0X25hbWVcIiwgXCJnZW5kZXJfb2ZfcGF0aWVudFwiLCBcInBhdGllbnRfYmlydGhfZGF0ZVwiLCBcInBhdGllbnRfbm90ZVwiLCBcInBhdGllbnRfZGVwYXJ0bWVudFwiLCBcImFjY2Vzc2lvbl9udW1iZXJcIiwgXCJzYW1wbGVfc2l0ZVwiLCBcInBoeXNpY2lhblwiLCBcIm9wZXJhdG9yXCIsIFwiZGVwYXJ0bWVudFwiLCBcIm5vdGVcIiwgXCJ0ZXN0X29yZGVyX2NvZGVcIiwgXCJkcmF3X3RpbWVcIiwgXCJhcHByb3ZhbF9zdGF0dXNcIiwgXCJhcHByb3ZhbF90aW1lXCIsIFwicmVwb3J0X2xheW91dFwiLCBcInBhdGllbnRfYWNjb3VudF9udW1iZXJcIiwgXCJub25lXzFcIiwgXCJlcnJvcnNfZGV0ZWN0ZWRfZHVyaW5nX21lYXN1cmVtZW50XCIsIFwiYWdlXCIsIFwiZXJyb3JfY29kZV8wMVwiLCBcIndlaWdodFwiLCBcImVycm9yX2NvZGVfMDJcIiwgXCJoZWlnaHRcIiwgXCJlcnJvcl9jb2RlXzAzXCIsIFwiaGNnX2JldGFfcFwiLCBcImVycm9yX2NvZGVfMDRcIiwgXCJ0cm9wb25pbl9pX3BcIiwgXCJlcnJvcl9jb2RlXzA1XCIsIFwiY2tfbWJfcFwiLCBcImVycm9yX2NvZGVfMDZcIiwgXCJkX2RpbWVyX3BcIiwgXCJlcnJvcl9jb2RlXzA3XCIsIFwiaHNjcnBfcFwiLCBcImVycm9yX2NvZGVfMDhcIiwgXCJteW9nbG9iaW5fcFwiLCBcImVycm9yX2NvZGVfMDlcIiwgXCJudF9wcm9ibnBcIiwgXCJlcnJvcl9jb2RlXzEwXCIsIFwiY3JwXCIsIFwiZXJyb3JfY29kZV8xMVwiLCBcImJucFwiLCBcImVycm9yX2NvZGVfMTJcIiwgXCJ0bnRcIiwgXCJlcnJvcl9jb2RlXzEzXCIsIFwiZGVtb19wXCIsIFwiZXJyb3JfY29kZV8xNFwiLCBcInBjdFwiLCBcImVycm9yX2NvZGVfMTVcIl1cbiAgICB9KVxuICAgICAgLmZyb21GaWxlKHRlc3REYXRhKVxuICAgICAgLnRoZW4oKGQpID0+IHtcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGQubGVuZ3RoLCAyKTtcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGRbMF0uc2FtcGxlX25vLCBcIjEyNjY5XCIpO1xuICAgICAgfSlcblxuICB9KTtcbiAgaXQgKFwic2hvdWxkIHN0cmVhbSBqc29uIHN0cmluZyBjb3JyZWN0bHlcIixmdW5jdGlvbihkb25lKXtcbiAgICBjb25zdCBkYXRhPWBhLGIsY1xuMSwyLDNcbjQsNSw2YFxuICAgIGxldCBoYXNMZWZ0QnJhY2tldD1mYWxzZTtcbiAgICBsZXQgaGFzUmlnaHRCcmFja2V0PWZhbHNlO1xuICAgIGNzdih7XG4gICAgICBkb3duc3RyZWFtRm9ybWF0OlwiYXJyYXlcIlxuICAgIH0pXG4gICAgLmZyb21TdHJpbmcoZGF0YSlcbiAgICAub24oXCJkYXRhXCIsKGQpPT57XG4gICAgICBjb25zdCBzdHI9ZC50b1N0cmluZygpO1xuICAgICAgaWYgKHN0clswXT09PVwiW1wiICYmIHN0ci5sZW5ndGggPT09Mil7XG4gICAgICAgIGhhc0xlZnRCcmFja2V0PXRydWU7XG4gICAgICB9ZWxzZSBpZiAoc3RyWzBdPT09XCJdXCIgJiYgc3RyLmxlbmd0aD09PTIpe1xuICAgICAgICBoYXNSaWdodEJyYWNrZXQ9dHJ1ZTtcbiAgICAgIH1lbHNle1xuICAgICAgICBhc3NlcnQuZXF1YWwoc3RyW3N0ci5sZW5ndGgtMl0sXCIsXCIpO1xuICAgICAgfVxuICAgICAgXG4gICAgfSlcbiAgICAub24oXCJlbmRcIiwoKT0+e1xuICAgICAgYXNzZXJ0LmVxdWFsKGhhc0xlZnRCcmFja2V0LHRydWUpO1xuICAgICAgYXNzZXJ0LmVxdWFsKGhhc1JpZ2h0QnJhY2tldCx0cnVlKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICB9KVxuICBpdCAoXCJzaG91bGQgc3RyZWFtIGpzb24gbGluZSBjb3JyZWN0bHlcIixmdW5jdGlvbihkb25lKXtcbiAgICBjb25zdCBkYXRhPWBhLGIsY1xuMSwyLDNcbjQsNSw2YFxuICAgIGNzdih7XG4gICAgICBkb3duc3RyZWFtRm9ybWF0OlwibGluZVwiXG4gICAgfSlcbiAgICAuZnJvbVN0cmluZyhkYXRhKVxuICAgIC5vbihcImRhdGFcIiwoZCk9PntcbiAgICAgIGNvbnN0IHN0cj1kLnRvU3RyaW5nKCk7XG4gICAgICBcbiAgICAgIGFzc2VydC5ub3RFcXVhbChzdHJbc3RyLmxlbmd0aC0yXSxcIixcIik7XG4gICAgfSlcbiAgICAub24oXCJlbmRcIiwoKT0+e1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gIH0pXG4gIGl0IChcInNob3VsZCBub3Qgc2VuZCBqc29uIGlmIG5lZWRFbWl0QWxsIGlzIGZhbHNlXCIsYXN5bmMgZnVuY3Rpb24oKXtcbiAgICBjb25zdCBkYXRhPWBhLGIsY1xuMSwyLDNcbjQsNSw2YFxuICAgIHJldHVybiBjc3Yoe1xuICAgICAgbmVlZEVtaXRBbGw6ZmFsc2VcbiAgICB9KVxuICAgIC5mcm9tU3RyaW5nKGRhdGEpXG4gICAgLnRoZW4oKGQpPT57XG4gICAgICBhc3NlcnQoZC5sZW5ndGg9PT0wKTtcbiAgICB9KVxuICB9KVxuICBpdCAoXCJzaG91bGQgY29udmVydCBudWxsIHRvIG51bGwgb2JqZWN0XCIsYXN5bmMgZnVuY3Rpb24oKXtcbiAgICBjb25zdCBkYXRhPWBhLGIsY1xubnVsbCwyLDNcbjQsNSw2YFxuICAgIHJldHVybiBjc3Yoe1xuICAgICAgbnVsbE9iamVjdDp0cnVlXG4gICAgfSlcbiAgICAuZnJvbVN0cmluZyhkYXRhKVxuICAgIC50aGVuKChkKT0+e1xuICAgICAgYXNzZXJ0LmVxdWFsKGRbMF0uYSxudWxsKVxuICAgIH0pXG4gIH0pXG4gIGl0IChcInNob3VsZCBwcm9jZXNzIHBlcmlvZCBwcm9wZXJseVwiLGFzeW5jIGZ1bmN0aW9uKCl7XG4gICAgY29uc3QgZGF0YT1gYS4uLGIsY1xuMSwyLDNcbjQsNSw2YFxuICAgIHJldHVybiBjc3Yoe1xuICAgIH0pXG4gICAgLmZyb21TdHJpbmcoZGF0YSlcbiAgICAudGhlbigoZCk9PntcbiAgICAgIGFzc2VydC5lcXVhbChkWzBdW1wiYS4uXCJdLDEpO1xuICAgICAgYXNzZXJ0LmVxdWFsKGRbMV1bXCJhLi5cIl0sNCk7XG4gICAgfSlcbiAgfSlcbn0pO1xuIl19